---
title: "Presentation 12-04"
author: "Florian Stijven"
date: "11-4-2022"
output:
  beamer_presentation:
    theme: "Madrid"
header-includes:
  - \usepackage{amsmath}
  - \usepackage{booktabs}
  - \usepackage{graphicx}
  - \logo{\includegraphics[width=1.5cm]{UHasselt_logo.png}}
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
setwd("C:\\Users\\Florian\\OneDrive\\Phd\\Master thesis\\R Implementation")
source(file = "density_functions.R")
source(file = "information_theoretic_functions_new.R")
library(purrr)
library(flexsurv)
library(Surrogate)
library(tidyverse)
library(survival)
library(mvtnorm)
data("Ovarian")
```

```{r}
#put data in correct format
data = Ovarian %>% select(Pfs, Surv, Treat, PfsInd, SurvInd)
data = data %>% filter(Pfs <= Surv)
```

```{r}
new_data = data
fit_s0 = flexsurvspline(formula = Surv(Pfs, PfsInd)~1, data = data, 
                         subset = data$Treat == 0, k = 2, scale = "hazard")
new_data[new_data$Treat == 0, 1] = 1 - predict(fit_s0, type = "survival",
                                               newdata = data[1,], 
                                               times = data[data$Treat == 0, 1])$.pred[[1]][,2]
fit_s1 = flexsurvspline(formula = Surv(Pfs, PfsInd)~1, data = data, 
                         subset = data$Treat == 1, k = 2, scale = "hazard")
new_data[new_data$Treat == 1, 1] = 1 - predict(fit_s1, type = "survival",
                                               newdata = data[4,], 
                                               times = data[data$Treat == 1, 1])$.pred[[1]][,2]
fit_t0 = flexsurvspline(formula = Surv(Surv, SurvInd)~1, data = data, 
                         subset = data$Treat == 0, k = 2, scale = "hazard")
new_data[new_data$Treat == 0, 2] = 1 - predict(fit_t0, type = "survival",
                                               newdata = data[1,], 
                                               times = data[data$Treat == 0, 2])$.pred[[1]][,2]
fit_t1 = flexsurvspline(formula = Surv(Surv, SurvInd)~1, data = data, 
                         subset = data$Treat == 1, k = 2, scale = "hazard")
new_data[new_data$Treat == 1, 2] = 1 - predict(fit_t1, type = "survival",
                                               newdata = data[4,], 
                                               times = data[data$Treat == 1,2])$.pred[[1]][,2]
```

```{r, results='hide'}
cop_fit_ctrl = fit_copula(data = new_data[new_data$Treat == 0,], inits = 2.5)
cop_fit_trt = fit_copula(data = new_data[new_data$Treat == 1,], inits = 2.5)
rho13 = (exp(cop_fit_ctrl$par[1]) - 1)/(exp(cop_fit_ctrl$par[1]) + 1)
rho24 = (exp(cop_fit_trt$par[1]) - 1)/(exp(cop_fit_trt$par[1]) + 1)
```

## Introduction

- Interval censoring versus right censoring in Ovarian data set:
  - Goodness of fit
  - Sensitivity analysis
- Gaussian copula model adapted for $Pr(PFS = OS) > 0$
  - Analysis of Ovarian data set with this adapted model

# Interval vs. Right Censoring

## Goodness of Fit (Right Censoring)

- Very long survival for small subgroup

```{r, out.height="80%"}
par(mfrow = c(2,2))
plot(fit_s0,type = "survival", t = seq(0, 15, 0.1), 
     xlim = c(0, 15), main = "S_0", xlab = "Time", ylab = "S(t)")
abline(a = 0, b = 0, col = "gray")

plot(fit_t0, type = "survival", t = seq(0, 15, 0.1), 
     xlim = c(0, 15), main = "S_1", xlab = "Time", ylab = "S(t)")
abline(a = 0, b = 0, col = "gray")

plot(fit_s1, type = "survival", t = seq(0, 15, 0.1), 
     xlim = c(0, 15), main = "T_0", xlab = "Time", ylab = "S(t)")
abline(a = 0, b = 0, col = "gray")

plot(fit_t1, type = "survival", t = seq(0, 15, 0.1), 
     xlim = c(0, 15), main = "T_1", xlab = "Time", ylab = "S(t)")
abline(a = 0, b = 0, col = "gray")
```

## Goodness of Fit (Right Censoring)

- Sample from fitted models
  - censoring times sampled from corresponding estimated distribution
- Lack of fit

```{r, out.height="70%"}
#estimate survival function for censoring
km_censor = flexsurvspline(Surv(pmax(Pfs, Surv), 1 - pmin(PfsInd, SurvInd))~1, 
                           data = data, k = 3)
#plot(km_censor)
#sample from KM-curve
U = runif(n = nrow(data))
C = qsurvspline(p = U, gamma = km_censor$coefficients, knots = km_censor$knots)

#sample from model for control
data_temp = data[data$Treat == 0,]
data_control = data_temp
n_temp = nrow(data_temp)
gauss_copula = copula::ellipCopula(family = "normal", param = rho13, dim = 2, dispstr = "un")
X = copula::rCopula(n_temp, gauss_copula)
data_temp$Pfs = pmin(qsurvspline(p = X[,1], gamma = fit_s0$coefficients, knots = fit_s0$knots), 
                        C[1:n_temp])
data_temp$Surv = pmin(qsurvspline(p = X[,2], gamma = fit_t0$coefficients, knots = fit_t0$knots),
                         C[1:n_temp])
cens = pmax(data_temp$Pfs, data_temp$Surv) == C[1:n_temp]
par(mfrow = c(2,2))
#plot sample and true data
plot(data_temp$Pfs[!cens], data_temp$Surv[!cens], 
     col = "red", xlim = c(0,2), ylim = c(0,2), 
     main = "Fitted Model", xlab = "S_0", ylab = "T_0")
points(data_temp$Pfs[cens], data_temp$Surv[cens])
plot(data_control$Pfs[(data_control$SurvInd == 1)], 
     data_control$Surv[(data_control$SurvInd == 1)], 
     col = "red", xlim = c(0,2), ylim = c(0,2), 
     main = "Observed Data", xlab = "S_0", ylab = "T_0")
points(data_control$Pfs[!(data_control$SurvInd == 1)], data_control$Surv[!(data_control$SurvInd == 1)])
#sample from model for control
data_temp = data[data$Treat == 1,]
data_control = data_temp
n_temp = nrow(data_temp)
gauss_copula = copula::ellipCopula(family = "normal", param = rho24, dim = 2, dispstr = "un")
X = copula::rCopula(n_temp, gauss_copula)
data_temp$Pfs = pmin(qsurvspline(p = X[,1], gamma = fit_s0$coefficients, knots = fit_s0$knots), 
                        C[1:n_temp])
data_temp$Surv = pmin(qsurvspline(p = X[,2], gamma = fit_t0$coefficients, knots = fit_t0$knots),
                         C[1:n_temp])
cens = pmax(data_temp$Pfs, data_temp$Surv) == C[1:n_temp]
#plot sample and true data
plot(data_temp$Pfs[!cens], data_temp$Surv[!cens], 
     col = "red", xlim = c(0,2), ylim = c(0,2), 
     main = "Fitted Model", xlab = "S_1", ylab = "T_1")
points(data_temp$Pfs[cens], data_temp$Surv[cens])
plot(data_control$Pfs[(data_control$SurvInd == 1)], 
     data_control$Surv[(data_control$SurvInd == 1)], 
     col = "red", xlim = c(0,2), ylim = c(0,2), 
     main = "Observed Data", xlab = "S_1", ylab = "T_1")
points(data_control$Pfs[!(data_control$SurvInd == 1)], data_control$Surv[!(data_control$SurvInd == 1)])
```

```{r}
grid = seq(-1, 1, 0.2)
Pos.Def.Matrices(T0S0 = rho13, T1S1 = rho24,
                 T0T1 = grid, S0S1 = grid, T1S0 = grid, T0S1 = grid)
# Generated.Matrices = readRDS(file = "many_matrices.RData")
posdef_gen_matrices = Generated.Matrices[Generated.Matrices$Pos.Def.Status == 1,]
# saveRDS(object = Generated.Matrices, file = "many_matrices.RData")
rho_delta = numeric()
for(i in 1:nrow(posdef_gen_matrices)){
  num = posdef_gen_matrices[i, "T0S0"] + posdef_gen_matrices[i, "T1S1"] - posdef_gen_matrices[i, "T1S0"] - posdef_gen_matrices[i, "T0S1"]
  denom = 2*sqrt((1 - posdef_gen_matrices[i, "T0T1"])*
                   (1 - posdef_gen_matrices[i, "S0S1"]))
  rho_delta = c(rho_delta, num/denom)
}
```

```{r}
I_vec = readRDS(file = "C:\\Users\\Florian\\OneDrive\\Phd\\Master thesis\\R Implementation\\I_vec.RData")
```



```{r}
#put data in correct format
data = Ovarian %>% select(Pfs, Surv, Treat, PfsInd, SurvInd)
data = data %>% filter(Pfs <= Surv)
max_death = 20
max_pfs = 15
data$Pfs2 = 0
data$Surv2 = 0
data$Pfs_cens = 0
data$Surv_cens = 0
for(i in 1:nrow(data)){
  if(data$PfsInd[i] == 1 & data$SurvInd[i] == 1){
    data$Pfs2[i] = data$Pfs[i]
    data$Surv2[i] = data$Surv[i]
    data$Pfs_cens[i] = 1
    data$Surv_cens[i] = 1
  }
  else if(data$PfsInd[i] == 1 & data$SurvInd[i] == 0){
    data$Pfs2[i] = data$Pfs[i]
    data$Surv2[i] = max_death
    data$Pfs_cens[i] = 1
    data$Surv_cens[i] = 3
  }
  else if(data$PfsInd[i] == 0 & data$SurvInd[i] == 1){
    #this cannot happen, PFS is <= OS
    print("death without PFS")
  }
  else{
    data$Pfs2[i] = max_pfs
    data$Surv2[i] = max_death
    data$Pfs_cens[i] = 3
    data$Surv_cens[i] = 3
  }
}
```


```{r}
new_data = data
par(mfrow = c(2,2))
fit_s0 = flexsurvspline(formula = Surv(time = Pfs, time2 = Pfs2, 
                                       type = "interval2")~1, 
                        data = data,
                        subset = data$Treat == 0, k = 3, scale = "hazard")
new_data[new_data$Treat == 0, 1] = 1 - predict(fit_s0, type = "survival",
                                               newdata = data[1,], 
                                               times = data[data$Treat == 0, 1])$.pred[[1]][,2]
fit_s1 = flexsurvspline(formula = Surv(time = Pfs, time2 = Pfs2,
                                       type = "interval2")~1, data = data, 
                         subset = data$Treat == 1, k = 3, scale = "hazard")
new_data[new_data$Treat == 1, 1] = 1 - predict(fit_s1, type = "survival",
                                               newdata = data[4,], 
                                               times = data[data$Treat == 1, 1])$.pred[[1]][,2]
fit_t0 = flexsurvspline(formula = Surv(time = Surv, time2 = Surv2,
                                       type = "interval2")~1, data = data, 
                         subset = data$Treat == 0, k = 3, scale = "hazard")
new_data[new_data$Treat == 0, 2] = 1 - predict(fit_t0, type = "survival",
                                               newdata = data[1,], 
                                               times = data[data$Treat == 0, 2])$.pred[[1]][,2]
fit_t1 = flexsurvspline(formula = Surv(time = Surv, time2 = Surv2,
                                       type = "interval2")~1, data = data, 
                         subset = data$Treat == 1, k = 3, scale = "hazard")
new_data[new_data$Treat == 1, 2] = 1 - predict(fit_t1, type = "survival",
                                               newdata = data[4,], 
                                               times = data[data$Treat == 1, 2])$.pred[[1]][,2]
```

## Goodness of Fit (Interval Censoring)

- max OS: 20 years
- max PFS: 15 years

```{r, out.height="80%"}
par(mfrow = c(2,2))
times = seq(0.1, 20, 0.1)
km_s0 = survfit(Surv(time = Pfs, event = PfsInd)~1,
                data = data, subset = data$Treat == 0)
plot(times, predict(fit_s0, newdata = data[1,], type = "survival", 
                    times = times)$.pred[[1]]$.pred,
     type = "l", col = "red", main = "S_0", xlab = "Time", ylab = "S(t)")
lines(km_s0)
abline(a = 0, b = 0, col = "gray")

km_s1 = survfit(Surv(time = Pfs, event = PfsInd)~1,
                data = data, subset = data$Treat == 1)
plot(times, predict(fit_s1, newdata = data[1,], type = "survival", 
                    times = times)$.pred[[1]]$.pred,
     type = "l", col = "red", main = "S_1", xlab = "Time", ylab = "S(t)")
lines(km_s1)
abline(a = 0, b = 0, col = "gray")

km_t0 = survfit(Surv(time = Surv, event = SurvInd)~1,
                data = data, subset = data$Treat == 0)
plot(times, predict(fit_t0, newdata = data[1,], type = "survival", 
                    times = times)$.pred[[1]]$.pred,
     type = "l", col = "red", main = "T_0", xlab = "Time", ylab = "S(t)")
lines(km_t0)
abline(a = 0, b = 0, col = "gray")

km_t1 = survfit(Surv(time = Surv, event = SurvInd)~1,
                data = data, subset = data$Treat == 1)
plot(times, predict(fit_t1, newdata = data[1,], type = "survival", 
                    times = times)$.pred[[1]]$.pred,
     type = "l", col = "red", main = "T_1", xlab = "Time", ylab = "S(t)")
lines(km_t1)
abline(a = 0, b = 0, col = "gray")
```

```{r, results='hide'}
cop_fit_ctrl = fit_copula(data = new_data[new_data$Treat == 0,], inits = 2.5)
cop_fit_trt = fit_copula(data = new_data[new_data$Treat == 1,], inits = 2.5)
rho13 = (exp(cop_fit_ctrl$par[1]) - 1)/(exp(cop_fit_ctrl$par[1]) + 1)
rho24 = (exp(cop_fit_trt$par[1]) - 1)/(exp(cop_fit_trt$par[1]) + 1)
```

## Goodness of Fit (Interval Censoring)

- Again clear lack of fit

```{r, out.height="75%"}
#estimate survival function for censoring
km_censor = flexsurvspline(Surv(pmax(Pfs, Surv), 1 - pmin(PfsInd, SurvInd))~1, 
                           data = data, k = 3)
#plot(km_censor)
#sample from KM-curve
U = runif(n = nrow(data))
C = qsurvspline(p = U, gamma = km_censor$coefficients, knots = km_censor$knots)

#sample from model for control
data_temp = data[data$Treat == 0,]
data_control = data_temp
n_temp = nrow(data_temp)
gauss_copula = copula::ellipCopula(family = "normal", param = rho13, dim = 2, dispstr = "un")
X = copula::rCopula(n_temp, gauss_copula)
data_temp$Pfs = pmin(qsurvspline(p = X[,1], gamma = fit_s0$coefficients, knots = fit_s0$knots), 
                        C[1:n_temp])
data_temp$Surv = pmin(qsurvspline(p = X[,2], gamma = fit_t0$coefficients, knots = fit_t0$knots),
                         C[1:n_temp])
cens = pmax(data_temp$Pfs, data_temp$Surv) == C[1:n_temp]
par(mfrow = c(2,2))
#plot sample and true data
plot(data_temp$Pfs[!cens], data_temp$Surv[!cens], 
     col = "red", xlim = c(0,2), ylim = c(0,2), 
     main = "Fitted Model", xlab = "S_0", ylab = "T_0")
points(data_temp$Pfs[cens], data_temp$Surv[cens])
plot(data_control$Pfs[(data_control$SurvInd == 1)], 
     data_control$Surv[(data_control$SurvInd == 1)], 
     col = "red", xlim = c(0,2), ylim = c(0,2), 
     main = "Observed Data", xlab = "S_0", ylab = "T_0")
points(data_control$Pfs[!(data_control$SurvInd == 1)], data_control$Surv[!(data_control$SurvInd == 1)])

#sample from model for control
data_temp = data[data$Treat == 1,]
data_control = data_temp
n_temp = nrow(data_temp)
gauss_copula = copula::ellipCopula(family = "normal", param = rho24, dim = 2, dispstr = "un")
X = copula::rCopula(n_temp, gauss_copula)
data_temp$Pfs = pmin(qsurvspline(p = X[,1], gamma = fit_s0$coefficients, knots = fit_s0$knots), 
                        C[1:n_temp])
data_temp$Surv = pmin(qsurvspline(p = X[,2], gamma = fit_t0$coefficients, knots = fit_t0$knots),
                         C[1:n_temp])
cens = pmax(data_temp$Pfs, data_temp$Surv) == C[1:n_temp]
#plot sample and true data
plot(data_temp$Pfs[!cens], data_temp$Surv[!cens], 
     col = "red", xlim = c(0,2), ylim = c(0,2), 
     main = "Fitted Model", xlab = "S_1", ylab = "T_1")
points(data_temp$Pfs[cens], data_temp$Surv[cens])
plot(data_control$Pfs[(data_control$SurvInd == 1)], 
     data_control$Surv[(data_control$SurvInd == 1)], 
     col = "red", xlim = c(0,2), ylim = c(0,2), 
     main = "Observed Data", xlab = "S_1", ylab = "T_1")
points(data_control$Pfs[!(data_control$SurvInd == 1)], data_control$Surv[!(data_control$SurvInd == 1)])
```

## Comparison of Sensitivity Analysis


```{r}
grid = seq(-1, 1, 0.2)
Pos.Def.Matrices(T0S0 = rho13, T1S1 = rho24,
                 T0T1 = grid, S0S1 = grid, T1S0 = grid, T0S1 = grid)
# Generated.Matrices = readRDS(file = "many_matrices.RData")
posdef_gen_matrices = Generated.Matrices[Generated.Matrices$Pos.Def.Status == 1,]
# saveRDS(object = Generated.Matrices, file = "many_matrices.RData")
rho_delta_int = numeric()
for(i in 1:nrow(posdef_gen_matrices)){
  num = posdef_gen_matrices[i, "T0S0"] + posdef_gen_matrices[i, "T1S1"] - posdef_gen_matrices[i, "T1S0"] - posdef_gen_matrices[i, "T0S1"]
  denom = 2*sqrt((1 - posdef_gen_matrices[i, "T0T1"])*
                   (1 - posdef_gen_matrices[i, "S0S1"]))
  rho_delta_int = c(rho_delta_int, num/denom)
}
```


```{r}
I_vec_int = readRDS(file = "C:\\Users\\Florian\\OneDrive\\Phd\\Master thesis\\R Implementation\\I_vec_int.RData")
par(mfrow = c(2, 2))
hist(1 - exp(-2*I_vec_int), main = "Interval Censoring",
     xlab = "R_h", xlim = c(0, 1), breaks = seq(0, 1, 0.05))
hist(1 - exp(-2*I_vec), main = "Right Censoring",
     xlab = "R_h", xlim = c(0, 1), breaks = seq(0, 1, 0.05))
plot(rho_delta_int, 1 - exp(-2*I_vec_int), main = "Interval Censoring", 
     ylim = c(0.4, 1), xlim = c(0.4, 1), xlab = "rho_delta", ylab = "R_h")
abline(a = 0, b = 1, col = "gray")
plot(rho_delta, 1 - exp(-2*I_vec), main = "Right Censoring", 
     ylim = c(0.4, 1), xlim = c(0.4, 1), xlab = "rho_delta", ylab = "R_h")
abline(a = 0, b = 1, col = "gray")
```


# Adapted Gaussian Copula Model


```{r, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
source(file = "C:\\Users\\Florian\\OneDrive\\Phd\\Master thesis\\R Implementation\\density_functions.R")
source(file = "C:\\Users\\Florian\\OneDrive\\Phd\\Master thesis\\R Implementation\\information_theoretic_functions_new.R")
library(purrr)
library(flexsurv)
library(Surrogate)
library(tidyverse)
library(survival)
library(mvtnorm)
data("Ovarian")
```

```{r}
#put data in correct format
data = read.csv("C:\\Users\\Florian\\OneDrive\\Phd\\Master thesis\\R Implementation\\ovarian.csv")
data = data[,-1]
data$Pfs = data$Pfs*12
data$Surv = data$Surv*12
```


## Model Description

- Gaussian Copula model with TTP ($T_1$) instead of PFS ($T_1^*$)
- OS corresponds to $T_2$
- Latent value for $T_1$ if $T_1 > T_2$
- model for (TTP, OS) induces model for (PFS, OS): $T_1^* = \min(T_1, T_2)$
  - if $T_1 > T_2$: $Pr(T_1^* = t, T_2 = t) = Pr(T_1 > t, T_2 = t) = f_\infty(t)$
  - if $T_1 \le T_2$: $Pr(T_1^* = t_1, T_2 = t_2) = Pr(T_1 = t, T_2 = t)$

![test]("C:\\Users\\Florian\\OneDrive\\Phd\\Master thesis\\R Implementation\\scr_copula.png"){width=70%}

## Goodness of Fit


```{r, results='hide'}
#number of knots
nknots = 2
#load function for log likelihood
source("C:\\Users\\Florian\\OneDrive\\Phd\\Master thesis\\R Implementation\\copula_SCR_fitting.R")
#CONTROL GROUP
#marginal fit as starting values
fit_s0 = flexsurvspline(formula = Surv(Pfs, PfsInd)~1, data = data, 
                         subset = data$Treat == 0, k = nknots, scale = "hazard")
fit_t0 = flexsurvspline(formula = Surv(Surv, SurvInd)~1, data = data, 
                         subset = data$Treat == 0, k = nknots, scale = "hazard")
inits = c(fit_s0$coefficients, fit_t0$coefficients, 3.23)
maxit = 100
fit_0 = optim(par = inits, fn = normal_loglik_florian, method = "BFGS",
      X = data$Pfs[data$Treat == 0], Y = data$Surv[data$Treat == 0], 
      d1 = data$PfsInd[data$Treat == 0], d2 = data$SurvInd[data$Treat == 0], k = nknots,
      knotsx = fit_s0$knots, knotsy = fit_t0$knots, 
      control = list(maxit = maxit, REPORT = 2, trace = TRUE, fnscale = -1))
rho13 = (exp(fit_0$par[9]) - 1)/(exp(fit_0$par[9]) + 1)
Sigma_0 = matrix(c(1,rho13, rho13, 1), nrow = 2)
#TREATED GROUP
#marginal fit as starting values
fit_s1 = flexsurvspline(formula = Surv(Pfs, PfsInd)~1, data = data, 
                         subset = data$Treat == 1, k = nknots, scale = "hazard")
fit_t1 = flexsurvspline(formula = Surv(Surv, SurvInd)~1, data = data, 
                         subset = data$Treat == 1, k = nknots, scale = "hazard")
inits = c(fit_s1$coefficients, fit_t1$coefficients, 3.23)
maxit = 100
fit_1 = optim(par = inits, fn = normal_loglik_florian, method = "BFGS",
      X = data$Pfs[data$Treat == 1], Y = data$Surv[data$Treat == 1], 
      d1 = data$PfsInd[data$Treat == 1], d2 = data$SurvInd[data$Treat == 1], k = nknots,
      knotsx = fit_s1$knots, knotsy = fit_t1$knots, 
      control = list(maxit = maxit, REPORT = 2, trace = TRUE, fnscale = -1))
rho24 = (exp(fit_1$par[9]) - 1)/(exp(fit_1$par[9]) + 1)
Sigma_1 = matrix(c(1,rho24, rho24, 1), nrow = 2)
```

- Survival function for TTP ($Pr(T_1 > t_1)$) not observable (latent variable)
  - Survival function for PFS is observable
  - $Pr(T^*_1 > t_1) = Pr(\min(T_1, T_2) > t_1) = Pr(T_1 > t_1, T_2 > t_1)$

```{r, out.width="75%"}
grid = seq(0.01, 36, 0.1)
par(mfrow = c(2,2))
#goodness of fit of marginal survival function of OS
Surv_t0 = 1 - psurvspline(q = grid, gamma = fit_0$par[5:8], knots = fit_t0$knots)
plot(survfit(Surv(Surv, SurvInd)~1, data = data, subset = data$Treat == 0),
     xlim = c(0, 36), main = "OS (0)", xlab = "time (months)", ylab = "S(t)")
lines(grid, Surv_t0, col = "red")

Surv_t1 = 1 - psurvspline(q = grid, gamma = fit_1$par[5:8], knots = fit_t1$knots)
plot(survfit(Surv(Surv, SurvInd)~1, data = data, subset = data$Treat == 1),
     xlim = c(0, 36), main = "OS (1)", xlab = "time (months)", ylab = "S(t)")
lines(grid, Surv_t1, col = "red")

#goodness of fit for marginal distribution of PFS
pfs_surv = function(s, gammas, gammat, knots, knott, Sigma){
  qs = qnorm(psurvspline(q = s, gamma = gammas, knots = knots))
  qt = qnorm(psurvspline(q = s, gamma = gammat, knots = knott))
  return(pmvnorm(lower = c(qs, qt), mean = c(0,0), sigma = Sigma))
}

probs0 = sapply(grid, pfs_surv, gammas = fit_0$par[1:4], gammat = fit_0$par[5:8],
              knots = fit_s0$knots, knott = fit_t0$knots, Sigma = Sigma_0)
plot(survfit(Surv(data$Pfs, pmax(data$PfsInd, data$SurvInd))~1, data = data, 
             subset = data$Treat == 0),
     xlim = c(0, 36), main = "PFS (0)", xlab = "time (months)", ylab = "S(t)")
lines(grid, probs0, col = "red")

probs1 = sapply(grid, pfs_surv, gammas = fit_1$par[1:4], gammat = fit_1$par[5:8],
              knots = fit_s1$knots, knott = fit_t1$knots, Sigma = Sigma_1)
plot(survfit(Surv(data$Pfs, pmax(data$PfsInd, data$SurvInd))~1, data = data, 
             subset = data$Treat == 1),
     xlim = c(0, 36), main = "PFS (1)", xlab = "time (months)", ylab = "S(t)")
lines(grid, probs1, col = "red")
```

## Goodness of Fit (ctd.)

- Much better fit than when ignoring time-orderings

```{r, out.width="80%"}
#estimate survival function for censoring
km_censor = flexsurvspline(Surv(pmax(Pfs, Surv), 1 - SurvInd)~1, 
                           data = data, k = 3)
#plot(km_censor)
#sample from KM-curve
U = runif(n = nrow(data))
C = qsurvspline(p = U, gamma = km_censor$coefficients, knots = km_censor$knots)
par(mfrow = c(2,2))
#sample from model for control
data_temp = data[data$Treat == 0,]
data_control = data_temp
n_temp = nrow(data_temp)
gauss_copula = copula::ellipCopula(family = "normal", param = rho13, dim = 2, dispstr = "un")
X = copula::rCopula(n_temp, gauss_copula)
data_temp$Surv = pmin(qsurvspline(p = X[,2], gamma = fit_t0$coefficients, knots = fit_t0$knots),
                         C[1:n_temp])
data_temp$Pfs = pmin(qsurvspline(p = X[,1], gamma = fit_s0$coefficients, knots = fit_s0$knots), 
                        C[1:n_temp], data_temp$Surv)
cens = pmax(data_temp$Pfs, data_temp$Surv) == C[1:n_temp]
#plot sample and true data
plot(data_temp$Pfs[!cens], data_temp$Surv[!cens], 
     col = "red", xlim = c(0,24), ylim = c(0,24), 
     main = "Fitted Model", xlab = "S_0", ylab = "T_0")
points(data_temp$Pfs[cens], data_temp$Surv[cens])
plot(data_control$Pfs[(data_control$SurvInd == 1)], 
     data_control$Surv[(data_control$SurvInd == 1)], 
     col = "red", xlim = c(0,24), ylim = c(0,24), 
     main = "Observed Data", xlab = "S_0", ylab = "T_0")
points(data_control$Pfs[!(data_control$SurvInd == 1)], data_control$Surv[!(data_control$SurvInd == 1)])

#sample from model for control
data_temp = data[data$Treat == 1,]
data_control = data_temp
n_temp = nrow(data_temp)
gauss_copula = copula::ellipCopula(family = "normal", param = rho24, dim = 2, dispstr = "un")
X = copula::rCopula(n_temp, gauss_copula)
data_temp$Surv = pmin(qsurvspline(p = X[,2], gamma = fit_t0$coefficients, knots = fit_t0$knots),
                         C[1:n_temp])
data_temp$Pfs = pmin(qsurvspline(p = X[,1], gamma = fit_s0$coefficients, knots = fit_s0$knots), 
                        C[1:n_temp], data_temp$Surv)

cens = data_temp$Surv == C[1:n_temp]
#plot sample and true data
plot(data_temp$Pfs[!cens], data_temp$Surv[!cens], 
     col = "red", xlim = c(0,24), ylim = c(0,24), 
     main = "Fitted Model", xlab = "S_1", ylab = "T_1")
points(data_temp$Pfs[cens], data_temp$Surv[cens])
plot(data_control$Pfs[(data_control$SurvInd == 1)], 
     data_control$Surv[(data_control$SurvInd == 1)], 
     col = "red", xlim = c(0,24), ylim = c(0,24), 
     main = "Observed Data", xlab = "S_1", ylab = "T_1")
points(data_control$Pfs[!(data_control$SurvInd == 1)], data_control$Surv[!(data_control$SurvInd == 1)])
```


## Sensitivity Analysis

$$\rho_{\Delta} = cor(q_{S_1} - q_{S_0}, q_{T_1} - q_{T_0}) = \frac{\rho_{S_0, T_0} + \rho_{S_1, T_1} - \rho_{S_0, T_1} - \rho_{S_1, T_0}}{2 \sqrt{(1 - \rho_{T_0, T_1})(1 - \rho_{S_0, S_1})}}$$

```{r, out.width="70%"}
grid = seq(-1, 1, 0.2)
Pos.Def.Matrices(T0S0 = rho13, T1S1 = rho24,
                 T0T1 = grid, S0S1 = grid, T1S0 = grid, T0S1 = grid)
# Generated.Matrices = readRDS(file = "many_matrices.RData")
posdef_gen_matrices = Generated.Matrices[Generated.Matrices$Pos.Def.Status == 1,]
# saveRDS(object = Generated.Matrices, file = "many_matrices.RData")
rho_delta_new = numeric()
for(i in 1:nrow(posdef_gen_matrices)){
  num = posdef_gen_matrices[i, "T0S0"] + posdef_gen_matrices[i, "T1S1"] - posdef_gen_matrices[i, "T1S0"] - posdef_gen_matrices[i, "T0S1"]
  denom = 2*sqrt((1 - posdef_gen_matrices[i, "T0T1"])*
                   (1 - posdef_gen_matrices[i, "S0S1"]))
  rho_delta_new = c(rho_delta_new, num/denom)
}
hist(rho_delta_new, main = "Sensitivity Analysis for rho_delta", xlab = "rho_delta", xlim = c(0, 1))
posdef_Sigma_list = as.list(1:nrow(posdef_gen_matrices))
for(i in 1:nrow(posdef_gen_matrices)){
  rho12 = posdef_gen_matrices[i, "S0S1"]
  rho13 = posdef_gen_matrices[i, "T0S0"]
  rho14 = posdef_gen_matrices[i, "T1S0"]
  rho23 = posdef_gen_matrices[i, "T0S1"]
  rho24 = posdef_gen_matrices[i, "T1S1"]
  rho34 = posdef_gen_matrices[i, "T0T1"]
  Sigma_temp = matrix(c(1, rho12, rho13, rho14,
                   rho12, 1, rho23, rho24,
                   rho13, rho23, 1, rho34,
                   rho14, rho24, rho34, 1), nrow = 4)
  posdef_Sigma_list[[i]] = Sigma_temp
}
```

## Sensitivity Analysis (ctd.)

$$\rho_{sp} = cor(R(\Delta S), R(\Delta T))$$
$$\tau =  P((\Delta S_1 - \Delta S_2)(\Delta T_1 - \Delta T_2) > 0) - P((\Delta S_1 - \Delta S_2)(\Delta T_1 - \Delta T_2) < 0)$$

```{r, out.width="90%"}
n_prec = 10000
p = length(posdef_Sigma_list)
kendall = 1:p
sp_rho = 1:p
for(i in 1:p){
  q_vec = rmvnorm(n = n_prec, mean = c(0,0,0,0), sigma = posdef_Sigma_list[[i]])
  u_vec = pnorm(q = q_vec)
  s0 = qsurvspline(p = u_vec[,1], gamma = fit_0$par[1:4], knots = fit_s0$knots)
  s1 = qsurvspline(p = u_vec[,2], gamma = fit_1$par[1:4], knots = fit_s1$knots)
  t0 = qsurvspline(p = u_vec[,3], gamma = fit_0$par[5:8], knots = fit_t0$knots)
  t1 = qsurvspline(p = u_vec[,4], gamma = fit_1$par[5:8], knots = fit_t1$knots)
  pfs0 = pmin(s0, t0)
  pfs1 = pmin(s1, t1)
  deltaS = pfs1 - pfs0
  deltaT = t1 - t0
  kendall[i] = cor.test(deltaS, deltaT, method = "kendall")$estimate
  sp_rho[i] = cor.test(deltaS, deltaT, method = "spearman")$estimate
}
par(mfrow = c(2,2))
hist(kendall, main = "Sensitivity Analysis for Kendall's tau", xlab = "tau", xlim = c(0, 1))
hist(sp_rho, main = "Sensitivity Analysis for Spearman's rho", xlab = "rho_sp", xlim = c(0, 1))
```

## Sensitivity Analysis (ctd.)



```{r}
pairs(data.frame(kendall, sp_rho, rho_delta_new))
```




